<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMSeqs2 Search</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        h1 { color: #333; }
        textarea { width: 100%; height: 200px; margin-bottom: 10px; }
        button { padding: 10px 20px; margin-right: 10px; }
        img { max-width: 200px; margin-bottom: 20px; } /* optional styling for the logo */
        .admin-panel { 
            margin-top: 30px; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .status { 
            margin-top: 10px; 
            padding: 10px; 
            border-radius: 4px; 
            display: none; 
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .progress-container {
            margin-top: 15px;
            display: none;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.5s;
            text-align: center;
            color: white;
            font-size: 12px;
            line-height: 20px;
        }
        .progress-text {
            margin-top: 5px;
            font-size: 12px;
        }
        /* Tabs styling */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
            margin-right: 0;
            border-radius: 0;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #fff;
            border-bottom: 2px solid #4CAF50;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
            animation: fadeEffect 1s;
        }
        @keyframes fadeEffect {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        /* Pipeline Run tab specific styling */
        .sample-id-container {
            margin-bottom: 20px;
        }
        .sample-id-container textarea {
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            font-family: monospace;
        }
        .config-option {
            margin-bottom: 10px;
        }
        .config-option label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .config-option input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        .run-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .run-button:hover {
            background-color: #45a049;
        }
        .run-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .console-output {
            width: 100%;
            height: 200px;
            background-color: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 10px;
            overflow-y: auto;
            margin-top: 15px;
            border-radius: 4px;
            display: none;
        }
        /* Query tab styling */
        .query-container {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        .query-editor {
            flex: 1;
            min-width: 400px;
        }
        .query-results {
            flex: 1;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            min-height: 400px;
        }
        #sqlQuery {
            width: 100%;
            height: 120px;
            font-family: 'Courier New', monospace;
            margin-bottom: 10px;
        }
        .pre-made-queries {
            margin-bottom: 10px;
        }
        #presetQueries {
            padding: 8px;
            width: 100%;
            margin-bottom: 10px;
        }
        .query-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .clear-button {
            background-color: #f44336;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .clear-button:hover {
            background-color: #d32f2f;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .results-table th {
            background-color: #f1f1f1;
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        .results-table td {
            padding: 8px;
            border: 1px solid #ddd;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .results-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .results-pagination {
            margin-top: 10px;
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        .pagination-button {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background-color: #f1f1f1;
            cursor: pointer;
            border-radius: 3px;
        }
        .pagination-button:hover {
            background-color: #ddd;
        }
        .pagination-info {
            padding: 5px 10px;
        }
        /* Search input fields */
        .search-input-container {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .search-control {
            margin-bottom: 8px;
        }
        .search-control label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .special-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <!-- logo -->
    <img src="{{ url_for('static', filename='images/recombia-logo.png') }}" alt="Recombia Logo" />

    <!-- heading -->
    <h1>Planter Genomic Pipeline</h1>

    <!-- Tab navigation -->
    <div class="tab">
        <button class="tablinks active" onclick="openTab(event, 'SearchTab')">MMSeqs2 Search</button>
        <button class="tablinks" onclick="openTab(event, 'PipelineTab')">Run Pipeline</button>
        <button class="tablinks" onclick="openTab(event, 'DatabaseTab')">Database Management</button>
        <button class="tablinks" onclick="openTab(event, 'QueryTab')">Database Query</button>
    </div>

    <!-- MMSeqs2 Search Tab -->
    <div id="SearchTab" class="tabcontent" style="display: block;">
        <h2>MMSeqs2 Search</h2>
        <form method="POST">
            <textarea name="sequence" id="sequenceInput" placeholder="Enter your protein sequence here"></textarea>
            <br>
            <button type="submit">Search</button>
            <button type="button" id="loadExample">Load Example</button>
        </form>
    </div>
    
    <!-- Run Pipeline Tab -->
    <div id="PipelineTab" class="tabcontent">
        <h2>Run Planter Pipeline</h2>
        <p>Enter sample IDs (one per line) to process through the Planter pipeline:</p>
        
        <div class="sample-id-container">
            <textarea id="sampleIds" placeholder="Enter sample IDs here (e.g., ERR13770160, SRR12068547, etc.)
One sample per line"></textarea>
            <button type="button" id="loadSampleIds" class="btn btn-sm">Load Example IDs</button>
        </div>
        
        <div class="config-options">
            <div class="config-option">
                <label for="cores">CPU Cores:</label>
                <input type="number" id="cores" value="16" min="1" max="128">
            </div>
            
            <div class="config-option">
                <label for="outdir">Output Directory:</label>
                <input type="text" id="outdir" value="outputs">
            </div>
            
            <div class="config-option">
                <label for="s3Bucket">S3 Bucket:</label>
                <input type="text" id="s3Bucket" value="recombia.planter">
            </div>
        </div>
        
        <button type="button" id="runPipeline" class="run-button">Run Pipeline</button>
        
        <div id="pipelineStatus" class="status"></div>
        
        <!-- Progress bar for pipeline -->
        <div id="pipelineProgressContainer" class="progress-container">
            <div class="progress">
                <div id="pipelineProgressBar" class="progress-bar" role="progressbar">0%</div>
            </div>
            <div id="pipelineProgressText" class="progress-text">Preparing pipeline...</div>
        </div>
        
        <!-- Console output -->
        <div id="consoleOutput" class="console-output"></div>
    </div>
    
    <!-- Database Management Tab -->
    <div id="DatabaseTab" class="tabcontent">
        <h2>Database Management</h2>
        <p>Use these tools to manage the reference database and FASTA file:</p>
        
        <button type="button" id="downloadDatabase">Download Database</button>
        <button type="button" id="createRefSeq">Create Reference FASTA</button>
        
        <div id="dbStatus" class="status"></div>
        
        <!-- Progress bar for download -->
        <div id="progressContainer" class="progress-container">
            <div class="progress">
                <div id="progressBar" class="progress-bar" role="progressbar">0%</div>
            </div>
            <div id="progressText" class="progress-text">Preparing download...</div>
        </div>
    </div>
    
    <!-- Database Query Tab -->
    <div id="QueryTab" class="tabcontent">
        <h2>Database Query</h2>
        <p>Run SQL queries against the database or choose a pre-made query:</p>
        
        <div class="query-container">
            <div class="query-editor">
                <div class="pre-made-queries">
                    <label for="presetQueries">Pre-made Queries:</label>
                    <select id="presetQueries">
                        <option value="">-- Select a query --</option>
                        <option value="database_summary">Database Summary</option>
                        <option value="organism_summary">Organism Summary</option>
                        <option value="sample_stats">Sample Statistics</option>
                        <option value="top_expressed_sequences">Top Expressed Sequences</option>
                        <option value="go_term_summary">GO Term Summary</option>
                        <option value="ec_number_summary">EC Number Summary</option>
                        <option value="cluster_stats">Cluster Statistics</option>
                        <option value="expression_distribution">Expression Distribution</option>
                        <option value="search_samples_by_id">Search Samples by ID</option>
                        <option value="search_sequence_by_seqhash">Search Sequence by Seqhash</option>
                    </select>
                </div>
                
                <!-- Input fields for special queries -->
                <div id="searchInputContainer" class="search-input-container" style="display:none;">
                    <div id="sampleSearchInput" class="search-control" style="display:none;">
                        <label for="sampleIds">Sample IDs (comma-separated):</label>
                        <input type="text" id="sampleIds" class="special-input" placeholder="e.g., SRR12068547, SRR12068548">
                        <button type="button" id="insertSampleIds" class="btn btn-sm">Insert to Query</button>
                    </div>
                    
                    <div id="seqhashSearchInput" class="search-control" style="display:none;">
                        <label for="seqhashIds">Seqhash IDs (comma-separated):</label>
                        <input type="text" id="seqhashIds" class="special-input" placeholder="e.g., hash123, hash456">
                        <button type="button" id="insertSeqhashIds" class="btn btn-sm">Insert to Query</button>
                    </div>
                </div>
                
                <textarea id="sqlQuery" placeholder="SELECT * FROM sequences LIMIT 10;"></textarea>
                
                <div class="query-buttons">
                    <button type="button" id="runQuery" class="run-button">Run Query</button>
                    <button type="button" id="clearResults" class="clear-button">Clear Results</button>
                </div>
                
                <div id="queryStatus" class="status"></div>
                
                <!-- Progress bar for query execution -->
                <div id="queryProgressContainer" class="progress-container">
                    <div class="progress">
                        <div id="queryProgressBar" class="progress-bar" role="progressbar">0%</div>
                    </div>
                    <div id="queryProgressText" class="progress-text">Executing query...</div>
                </div>
            </div>
            
            <div class="query-results">
                <h3>Results</h3>
                <div id="resultsContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching function
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            
            // Hide all tab content
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            // Remove "active" class from all tab buttons
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            
            // Show the current tab and add "active" class to the button
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        $(document).ready(function() {
            // Load example sequence
            $('#loadExample').click(function() {
                $.get('/load_example', function(data) {
                    if (data.sequence) {
                        $('#sequenceInput').val(data.sequence);
                    } else {
                        alert('Failed to load example sequence');
                    }
                }).fail(function() {
                    alert('Error: Failed to load example sequence');
                });
            });
            
            // Database Query Tab functionality
            $('#presetQueries').change(function() {
                const selectedQuery = $(this).val();
                
                // Hide all special input containers first
                $('#searchInputContainer').hide();
                $('#sampleSearchInput').hide();
                $('#seqhashSearchInput').hide();
                
                if (selectedQuery) {
                    // Show loading state
                    $('#queryStatus').removeClass('success error').hide();
                    $('#queryProgressContainer').show();
                    $('#queryProgressBar').css('width', '0%').text('0%');
                    $('#queryProgressText').text('Loading query...');
                    
                    // Fetch the selected query template
                    $.ajax({
                        url: '/get_preset_query',
                        type: 'GET',
                        data: { query_name: selectedQuery },
                        success: function(response) {
                            if (response.query) {
                                $('#sqlQuery').val(response.query);
                                $('#queryProgressContainer').hide();
                                
                                // Show appropriate input fields for special queries
                                if (selectedQuery === 'search_samples_by_id') {
                                    $('#searchInputContainer').show();
                                    $('#sampleSearchInput').show();
                                }
                                else if (selectedQuery === 'search_sequence_by_seqhash') {
                                    $('#searchInputContainer').show();
                                    $('#seqhashSearchInput').show();
                                }
                            } else {
                                $('#queryStatus')
                                    .addClass('error')
                                    .text(response.message || 'Failed to load query template')
                                    .show();
                            }
                        },
                        error: function(xhr) {
                            $('#queryProgressContainer').hide();
                            let errorMessage = 'Failed to load query template';
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage = xhr.responseJSON.message;
                            }
                            $('#queryStatus')
                                .addClass('error')
                                .text(errorMessage)
                                .show();
                        }
                    });
                }
            });
            
            // Handler for sample ID insertion
            $('#insertSampleIds').click(function() {
                let sampleIds = $('#sampleIds').val().trim();
                console.log("Sample IDs input:", sampleIds);
                
                if (!sampleIds) {
                    alert('Please enter at least one sample ID');
                    return;
                }
                
                // Parse and format the sample IDs
                const ids = sampleIds.split(',').map(id => id.trim()).filter(id => id);
                console.log("Parsed IDs:", ids);
                
                if (ids.length === 0) {
                    alert('No valid sample IDs found');
                    return;
                }
                
                // Format the IDs as SQL string literals
                const formattedIds = ids.map(id => `'${id}'`).join(', ');
                console.log("Formatted IDs:", formattedIds);
                
                // Replace the placeholder in the SQL
                let sql = $('#sqlQuery').val();
                const originalSql = sql;
                sql = sql.replace('@sample_ids@', formattedIds);
                console.log("SQL before:", originalSql);
                console.log("SQL after:", sql);
                
                // Check if replacement actually happened
                if (sql === originalSql) {
                    alert('Could not find @sample_ids@ placeholder in the query. Please ensure the query contains this placeholder.');
                    return;
                }
                
                $('#sqlQuery').val(sql);
                
                // Visual feedback
                $('#sampleSearchInput').css('background-color', '#d4edda').delay(500).queue(function() {
                    $(this).css('background-color', '').dequeue();
                });
            });
            
            // Handler for seqhash ID insertion
            $('#insertSeqhashIds').click(function() {
                let seqhashIds = $('#seqhashIds').val().trim();
                console.log("Seqhash IDs input:", seqhashIds);
                
                if (!seqhashIds) {
                    alert('Please enter at least one seqhash ID');
                    return;
                }
                
                // Parse and format the seqhash IDs
                const ids = seqhashIds.split(',').map(id => id.trim()).filter(id => id);
                console.log("Parsed IDs:", ids);
                
                if (ids.length === 0) {
                    alert('No valid seqhash IDs found');
                    return;
                }
                
                // Format the IDs as SQL string literals
                const formattedIds = ids.map(id => `'${id}'`).join(', ');
                console.log("Formatted IDs:", formattedIds);
                
                // Replace the placeholder in the SQL
                let sql = $('#sqlQuery').val();
                const originalSql = sql;
                sql = sql.replace('@seqhash_ids@', formattedIds);
                console.log("SQL before:", originalSql);
                console.log("SQL after:", sql);
                
                // Check if replacement actually happened
                if (sql === originalSql) {
                    alert('Could not find @seqhash_ids@ placeholder in the query. Please ensure the query contains this placeholder.');
                    return;
                }
                
                $('#sqlQuery').val(sql);
                
                // Visual feedback
                $('#seqhashSearchInput').css('background-color', '#d4edda').delay(500).queue(function() {
                    $(this).css('background-color', '').dequeue();
                });
            });
            
            // Run SQL query
            $('#runQuery').click(function() {
                const btn = $(this);
                const originalText = btn.text();
                const query = $('#sqlQuery').val();
                
                if (!query) {
                    alert('Please enter a SQL query');
                    return;
                }
                
                // Show loading state
                btn.text('Executing...').prop('disabled', true);
                $('#queryStatus').removeClass('success error').hide();
                $('#queryProgressContainer').show();
                $('#queryProgressBar').css('width', '0%').text('0%');
                $('#queryProgressText').text('Executing query...');
                
                // Execute the query
                $.ajax({
                    url: '/execute_query',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ query: query }),
                    success: function(response) {
                        $('#queryProgressContainer').hide();
                        
                        if (response.status === 'success') {
                            $('#queryStatus')
                                .addClass('success')
                                .text('Query executed successfully')
                                .show();
                            
                            // Display the results
                            displayQueryResults(response.results, response.columns);
                        } else {
                            $('#queryStatus')
                                .addClass('error')
                                .text(response.message || 'Query execution failed')
                                .show();
                        }
                    },
                    error: function(xhr) {
                        $('#queryProgressContainer').hide();
                        let errorMessage = 'Query execution failed';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        $('#queryStatus')
                            .addClass('error')
                            .text(errorMessage)
                            .show();
                    },
                    complete: function() {
                        btn.text(originalText).prop('disabled', false);
                    }
                });
            });
            
            // Clear results
            $('#clearResults').click(function() {
                $('#resultsContainer').empty();
                $('#queryStatus').removeClass('success error').hide();
            });
            
            // Function to display query results as a paginated table
            function displayQueryResults(results, columns) {
                const container = $('#resultsContainer');
                container.empty();
                
                if (!results || results.length === 0) {
                    container.html('<p>No results found</p>');
                    return;
                }
                
                // Create the table
                const table = $('<table class="results-table"></table>');
                
                // Add the header row
                const headerRow = $('<tr></tr>');
                columns.forEach(column => {
                    headerRow.append(`<th>${column}</th>`);
                });
                table.append($('<thead></thead>').append(headerRow));
                
                // Add the data rows (paginated)
                const tbody = $('<tbody></tbody>');
                const pageSize = 15;
                let currentPage = 1;
                const totalPages = Math.ceil(results.length / pageSize);
                
                // Function to render a page of results
                function renderPage(page) {
                    tbody.empty();
                    const startIdx = (page - 1) * pageSize;
                    const endIdx = Math.min(startIdx + pageSize, results.length);
                    
                    for (let i = startIdx; i < endIdx; i++) {
                        const row = $('<tr></tr>');
                        columns.forEach(column => {
                            let cellValue = results[i][column];
                            
                            // Handle null values
                            if (cellValue === null) {
                                cellValue = '<em>NULL</em>';
                            }
                            
                            // Handle objects and arrays (convert to string)
                            if (typeof cellValue === 'object') {
                                cellValue = JSON.stringify(cellValue);
                            }
                            
                            row.append(`<td title="${cellValue}">${cellValue}</td>`);
                        });
                        tbody.append(row);
                    }
                }
                
                // Render the first page
                renderPage(currentPage);
                table.append(tbody);
                container.append(table);
                
                // Add pagination if needed
                if (totalPages > 1) {
                    const pagination = $('<div class="results-pagination"></div>');
                    
                    // Previous button
                    const prevButton = $('<button class="pagination-button" id="prevPage">Previous</button>');
                    prevButton.prop('disabled', currentPage === 1);
                    prevButton.on('click', function() {
                        if (currentPage > 1) {
                            currentPage--;
                            renderPage(currentPage);
                            updatePaginationState();
                        }
                    });
                    
                    // Next button
                    const nextButton = $('<button class="pagination-button" id="nextPage">Next</button>');
                    nextButton.prop('disabled', currentPage === totalPages);
                    nextButton.on('click', function() {
                        if (currentPage < totalPages) {
                            currentPage++;
                            renderPage(currentPage);
                            updatePaginationState();
                        }
                    });
                    
                    // Page info
                    const pageInfo = $(`<span class="pagination-info">Page ${currentPage} of ${totalPages}</span>`);
                    
                    // Update buttons and info when changing pages
                    function updatePaginationState() {
                        prevButton.prop('disabled', currentPage === 1);
                        nextButton.prop('disabled', currentPage === totalPages);
                        pageInfo.text(`Page ${currentPage} of ${totalPages}`);
                    }
                    
                    pagination.append(prevButton);
                    pagination.append(pageInfo);
                    pagination.append(nextButton);
                    container.append(pagination);
                }
                
                // Add result count
                container.prepend(`<p><strong>${results.length}</strong> results found</p>`);
            }
            
            // Load example sample IDs
            $('#loadSampleIds').click(function() {
                const exampleIds = "ERR13770160\nSRR12068547\nSRR12068548\nSRR12068549\nSRR12068550\nSRR12068551";
                $('#sampleIds').val(exampleIds);
            });
            
            // Run pipeline button handler
            $('#runPipeline').click(function() {
                const btn = $(this);
                const originalText = btn.text();
                
                // Get sample IDs and other configuration parameters
                const sampleIds = $('#sampleIds').val().trim();
                if (!sampleIds) {
                    alert('Please enter at least one sample ID');
                    return;
                }
                
                // Parse sample IDs (split by newlines)
                const samples = sampleIds.split(/\n/).map(s => s.trim()).filter(s => s);
                if (samples.length === 0) {
                    alert('No valid sample IDs found');
                    return;
                }
                
                // Get other configuration options
                const cores = $('#cores').val() || 16;
                const outdir = $('#outdir').val() || 'outputs';
                const s3Bucket = $('#s3Bucket').val() || 'recombia.planter';
                
                // Disable button and show progress
                btn.text('Starting pipeline...').prop('disabled', true);
                $('#pipelineStatus').removeClass('success error').hide();
                $('#pipelineProgressContainer').show();
                $('#pipelineProgressBar').css('width', '0%').text('0%');
                $('#pipelineProgressText').text('Preparing to run pipeline...');
                $('#consoleOutput').show().text('> Initializing pipeline...\n');
                
                // Format sample list for command
                const sampleList = JSON.stringify(samples);
                
                // Submit to the run_pipeline endpoint
                $.ajax({
                    url: '/run_pipeline',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        cores: cores,
                        outdir: outdir,
                        s3_bucket: s3Bucket,
                        samples: sampleList
                    }),
                    success: function(response) {
                        // Show job started message
                        appendToConsole('> Pipeline job started with ID: ' + response.job_id);
                        appendToConsole('> Monitoring job status...');
                        
                        // Start polling for job status
                        monitorPipelineJob(response.job_id, btn, originalText);
                    },
                    error: function(xhr) {
                        let errorMessage = 'Failed to start pipeline';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        $('#pipelineProgressContainer').hide();
                        $('#pipelineStatus')
                            .addClass('error')
                            .text(errorMessage)
                            .show();
                        btn.text(originalText).prop('disabled', false);
                        appendToConsole('> ERROR: ' + errorMessage);
                    }
                });
            });
            
            // Function to monitor pipeline job status
            function monitorPipelineJob(jobId, button, originalButtonText) {
                let pollInterval = setInterval(function() {
                    $.ajax({
                        url: '/pipeline_status/' + jobId,
                        type: 'GET',
                        success: function(response) {
                            // Update progress based on status
                            if (response.status === 'running') {
                                // Update progress
                                const progress = response.progress || 0;
                                $('#pipelineProgressBar').css('width', progress + '%').text(progress + '%');
                                $('#pipelineProgressText').text(response.message || 'Running...');
                                
                                // Append new logs if any
                                if (response.logs && response.logs.length > 0) {
                                    appendToConsole(response.logs.join('\n'));
                                }
                            } 
                            else if (response.status === 'completed') {
                                // Pipeline finished successfully
                                clearInterval(pollInterval);
                                $('#pipelineProgressBar').css('width', '100%').text('100%');
                                $('#pipelineProgressText').text('Pipeline completed successfully!');
                                
                                // Show any final logs
                                if (response.logs && response.logs.length > 0) {
                                    appendToConsole(response.logs.join('\n'));
                                }
                                
                                appendToConsole('> Pipeline completed successfully!');
                                
                                // Show success message
                                $('#pipelineStatus')
                                    .addClass('success')
                                    .text('Pipeline completed successfully!')
                                    .show();
                                
                                // Reset button
                                button.text(originalButtonText).prop('disabled', false);
                            }
                            else if (response.status === 'failed') {
                                // Pipeline failed
                                clearInterval(pollInterval);
                                $('#pipelineProgressContainer').hide();
                                
                                // Show any error logs
                                if (response.logs && response.logs.length > 0) {
                                    appendToConsole(response.logs.join('\n'));
                                }
                                
                                appendToConsole('> ERROR: Pipeline failed: ' + (response.message || 'Unknown error'));
                                
                                // Show error message
                                $('#pipelineStatus')
                                    .addClass('error')
                                    .text('Pipeline failed: ' + (response.message || 'Unknown error'))
                                    .show();
                                
                                // Reset button
                                button.text(originalButtonText).prop('disabled', false);
                            }
                        },
                        error: function(xhr) {
                            // Error checking job status
                            clearInterval(pollInterval);
                            let errorMessage = 'Failed to check job status';
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage = xhr.responseJSON.message;
                            }
                            
                            appendToConsole('> ERROR: ' + errorMessage);
                            
                            $('#pipelineStatus')
                                .addClass('error')
                                .text(errorMessage)
                                .show();
                            
                            button.text(originalButtonText).prop('disabled', false);
                        }
                    });
                }, 2000); // Poll every 2 seconds
            }
            
            // Helper function to append text to console output
            function appendToConsole(text) {
                const console = $('#consoleOutput');
                console.append(text + '\n');
                // Auto-scroll to bottom
                console.scrollTop(console[0].scrollHeight);
            }
            
            // Download database from S3
            $('#downloadDatabase').click(function() {
                const btn = $(this);
                const originalText = btn.text();
                
                btn.text('Starting...').prop('disabled', true);
                $('#dbStatus').removeClass('success error').hide();
                $('#progressContainer').show();
                $('#progressBar').css('width', '0%').text('0%');
                $('#progressText').text('Preparing download...');
                
                // Start the download
                $.ajax({
                    url: '/download_database',
                    type: 'POST',
                    success: function(response) {
                        if (response.status === 'started') {
                            // Show progress bar and start polling for progress
                            const s3Path = response.s3_path;
                            const outputPath = response.output_path;
                            
                            // Start monitoring the progress
                            monitorDownloadProgress(s3Path, outputPath, btn, originalText);
                        } else if (response.status === 'error') {
                            // Handle immediate error
                            $('#progressContainer').hide();
                            $('#dbStatus')
                                .addClass('error')
                                .text(response.message)
                                .show();
                            btn.text(originalText).prop('disabled', false);
                        }
                    },
                    error: function(xhr) {
                        let errorMessage = 'Failed to start download';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        $('#progressContainer').hide();
                        $('#dbStatus')
                            .addClass('error')
                            .text(errorMessage)
                            .show();
                        btn.text(originalText).prop('disabled', false);
                    }
                });
            });
            
            // Function to monitor download progress
            function monitorDownloadProgress(s3Path, outputPath, button, originalButtonText) {
                let downloadInterval = setInterval(function() {
                    $.ajax({
                        url: '/download_progress',
                        type: 'GET',
                        data: {
                            's3_path': s3Path,
                            'output_path': outputPath
                        },
                        success: function(response) {
                            // Update progress bar
                            if (response.status === 'downloading' || response.status === 'started') {
                                const progress = response.progress || 0;
                                $('#progressBar').css('width', progress + '%').text(progress + '%');
                                
                                if (response.human_size) {
                                    $('#progressText').text(response.human_size + ' - ' + response.message);
                                } else {
                                    $('#progressText').text(response.message);
                                }
                                
                                button.text('Downloading...').prop('disabled', true);
                            } 
                            else if (response.status === 'success') {
                                // Download complete
                                clearInterval(downloadInterval);
                                $('#progressBar').css('width', '100%').text('100%');
                                
                                if (response.human_size) {
                                    $('#progressText').text(response.human_size + ' - Complete!');
                                } else {
                                    $('#progressText').text('Download complete!');
                                }
                                
                                // Show success message
                                $('#dbStatus')
                                    .addClass('success')
                                    .text(response.message)
                                    .show();
                                    
                                // Reset button
                                button.text(originalButtonText).prop('disabled', false);
                                
                                // Hide progress bar after a delay
                                setTimeout(function() {
                                    $('#progressContainer').fadeOut();
                                }, 3000);
                            }
                            else if (response.status === 'error') {
                                // Error occurred
                                clearInterval(downloadInterval);
                                $('#progressContainer').hide();
                                $('#dbStatus')
                                    .addClass('error')
                                    .text(response.message)
                                    .show();
                                button.text(originalButtonText).prop('disabled', false);
                            }
                        },
                        error: function(xhr) {
                            // Error checking progress
                            clearInterval(downloadInterval);
                            let errorMessage = 'Failed to check download progress';
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage = xhr.responseJSON.message;
                            }
                            $('#progressContainer').hide();
                            $('#dbStatus')
                                .addClass('error')
                                .text(errorMessage)
                                .show();
                            button.text(originalButtonText).prop('disabled', false);
                        }
                    });
                }, 1000); // Check every second
            }
            
            // Create reference FASTA file
            $('#createRefSeq').click(function() {
                const btn = $(this);
                const originalText = btn.text();
                
                btn.text('Creating...').prop('disabled', true);
                $('#dbStatus').removeClass('success error').hide();
                
                // Show progress indication
                $('#progressContainer').show();
                $('#progressBar').css('width', '0%').text('0%');
                $('#progressText').text('Extracting representative sequences...');
                
                // Simulate progress for this operation (as we don't have real progress tracking for this one)
                let fakeProgress = 0;
                const progressInterval = setInterval(function() {
                    fakeProgress += Math.random() * 10;
                    if (fakeProgress > 95) {
                        fakeProgress = 95; // Cap at 95% until we get the real result
                    }
                    $('#progressBar').css('width', fakeProgress + '%').text(Math.floor(fakeProgress) + '%');
                }, 300);
                
                $.ajax({
                    url: '/create_refseq',
                    type: 'POST',
                    success: function(response) {
                        clearInterval(progressInterval);
                        
                        // Complete the progress bar
                        $('#progressBar').css('width', '100%').text('100%');
                        
                        // Update the progress text with sequence count
                        if (response.count) {
                            $('#progressText').text(`Extracted ${response.count} representative sequences`);
                        } else {
                            $('#progressText').text('Complete!');
                        }
                        
                        // Show success message
                        $('#dbStatus')
                            .addClass('success')
                            .text(response.message + ` (${response.count} sequences)`)
                            .show();
                            
                        // Hide progress bar after a delay
                        setTimeout(function() {
                            $('#progressContainer').fadeOut();
                        }, 3000);
                    },
                    error: function(xhr) {
                        clearInterval(progressInterval);
                        $('#progressContainer').hide();
                        
                        let errorMessage = 'Failed to create reference FASTA';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        $('#dbStatus')
                            .addClass('error')
                            .text(errorMessage)
                            .show();
                    },
                    complete: function() {
                        btn.text(originalText).prop('disabled', false);
                    }
                });
            });
        });
    </script>
</body>
</html>
